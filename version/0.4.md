JSTP/0.4 - JSON Transfer Protocol version 0.4
=============================================

> This document is a work in progress

> Versions [0.2](version/pseudo0.2.md) and [0.3](version/pseudo0.3.md) were not described but represent modular updates prior to version 0.4.

1 Introduction
--------------

JSTP is a communication protocol designed to:

- Facilitate distributed computing with an abstract, high level API inspired in HTTP
- Standarize interactions among applications connecting with different roles either as clients or servers

JSTP is also designed to be up to the paradigm of modern applications:

- JSTP is JSON, which makes it trivial to parse the messages is modern programming languages.
- The API closely resembles REST, so is very natural to adopt for web developers.
- Responses are sent asynchronously, thus making it fit for parallel processing.
- Messages ( _dispatches_ ) are symmetrical, so every node manages resources with the same API, whether is a server or a client node.
- Supports subscription ( _binding_ ) to events in remote hosts.
- JSTP is extensible, since arbitrary headers can be added

### 1.1 Example

How does a regular JSTP Dispatch looks like?

```javascript
{
  "protocol":   ["JSTP", "0.4"],      // The protocol and version
  "method":     "GET",                // The method. Headers are case-insensitive but is customary to user uppercase
                                      // in this one after the HTTP convention
  "resource":   ["foods", "pizza"],   // The selected resource which is to be retrieved (since the method is GET)
  "timestamp":  1365647440759,        // The milliseconds since the 1970-01-01 00:00:00.000 (also known as the UNIX timestamp)
  "token":      ["3434h5098asr34h3"], // [optional] Just some id which the server will probably use to identify this request
  "host":       ["pizza.com.ar"],     // [optional] The destination host to which the Dispatch is to be sent
  "body":       {                     // [optional] A message body
    "message": "Let the cheese melt!"       
  }
}
```

#### 1.1.1 Subscription example

A subscription Dispatch looks slightly different:

```javascript
{
  "protocol":   ["JSTP", "0.4"],
  "method":     "BIND",               // I bind myself to this event
  "endpoint": {                       // The endpoint header carries a pattern which represents possible Dispatches
    "method":   "POST",               // The type of dispatches I'd like to subscribe to. It can be replaced with a wilcard (*)
    "resource": ["foods", "*"]        // The resource. The second element is a wildcard representing "anything"
  },
  "timestamp":  1365647440759,
  "token":      ["3434h5098asr34h3"],
  "host":       ["pizza.com.ar"]      // The host is still optional. I can perfectly subscribe for dispatches 
                                      // issued in this very engine  
}
```

#### 1.1.2 Exception example

A low level, exception Dispatch:

```javascript
{
  "protocol":   ["JSTP", "0.4"],
  "timestamp":  1365647440759,
  "token":      ["3434h5098asr34h3"],
  "exception": {                      // The exception header contents the information about the error
    "code": 400,                      // The status code. Shamelessly the same as the HTTP ones
    "message": "Bad Dispatch"         // A description the error
  }
}
```

### 1.2 Notation

JSTP Dispatches are designed from the bottom up to be as compatible with current industry standards as possible. That's why they can be represented as URLs and also can be represented in a similar fashion to HTTP Requests. These notations are not normative however and may not be supported in actual implementations.

#### 1.2.1 URL

The first sample Dispatch may be represented as an URL like this:

    jstp://pizza.com.ar/foods/pizza

User Agents may convert this URL to the corresponding Dispatch

#### 1.2.2 HTTP⁻like syntax

The first sample Dispatch may be represented in an HTTP-like notation like this:

```
GET /foods/pizza JSTP/0.4
host: pizza.com.ar
timestamp: 1365647440759
token: 3434h5098asr34h3

message: Let the cheese melt!
```

This notation should be used for clarity since raw JSON can be messy, for example it can be used in log files. 

The notation is documented here partially to showcase the similarities with HTTP, but may not be supported at all by the user agents.

2 Terminology
-------------

- Dispatch: A JSTP message. Dispatches are JSON serializations.


- Engine: An implementation of a JSTP client-server. Since JSTP is symmetric in design, implementations should be capables of both roles (thus _server_ being a misleading designation). Implementations may however be limited to one role due to the runtime enviroment (for example while in a web browser). Engine can also refer to an running instance of a client-server compliant with this specification.

- Application: the program which resources the Engine has access to. In a broader sense may refer to the whole application topology of a distributed system.

- Dispatch processing: Whenever an Engine recognizes a Dispatch at aimed at it. The Dispatch doesn't get forwarded when is processed.

- Dispatch forwarding: Whenever an Engine finds that a Dispatch should be sent to another application, the Dispatch is forwarded to be processed in the remote application.

- Method: The action to be performed on the identified resource.

- Resource: The address of an actionable resource within the target application.

- Host: The computer in which the engine is running.

- Transport protocol: TCP sockets or Websockets. JSTP can be transported in various lower-level protocols.

- Client: An engine making a request to an application identified by its host (typically resolving its address through DNS or just using the IP).

- Inbound: A JSTP connection where the current engine has the server role.

- Outbound: A JSTP connnection where the current engine has the client role.

- Header: Any of the top level properties of the Dispatch object. For example: `protocol`, `method`, `body`...

- Endpoint: A description of a method/resource pair where both the method may be replaced by a wildcard and the resource may be replaced partially ot totally by a wilcard. The endpoint is a pattern representing the ocurrence or a series of Dispatches. It is normalized and it is applied in subscriptions.

- Subscription: The binding of an application resource which wants to receive the dispatches processed in this engine or a remote one. 

- Endpoint triggering: Whenever a Dispatch is processed the endpoints that match the Dispatch are triggered. If there are clients (internal or remote) subscribed to any of those endpoints, the Dispatch gets forwarded into them.

- Exception: An exception is a protocol-level error that needs to be reported back to the source of the Dispatch. When an exception occurs, the engine should address an Exception Dispatch back to the source engine.

3 Dispatch
----------

The JSTP Dispatch is both the message object that gets sent over the network and the event that gets triggered in the destination application. When is sent over the network, the Dispatch is a JSON serialization: within the Engine, it may be represented as a Dispatch object according to the programming language conventions.

A Dispatch is conformed by a series of _Headers_. There are 9 supported Headers, but other, non-normalized Headers may be added. Engines should discard any headers that can't be understood.

### 3.1 Headers

> All headers are case-insensitive.

#### 3.1.1 Protocol

- Type: Array of Strings.
- Elements: 
  1. "JSTP" - A string stating that the Dispatch uses the JSTP protocol. This field is case insensitive.
  2. <version-number> - A string representing the JSTP version number.
- _Required_

The protocol header represents the JSTP protocol version that the emitting Engine is using, and subsequently the JSTP version that the Dispatch is written in. It consists of an array of strings, being the first "jstp" and the second the version number.

The version number must be used by the receiving Engine to process the Dispatch according to the specifications of the JSTP version. If the engine is unable to process the Dispatch version it must send an Exception Dispatch back to the source.

> The protocol header may be extended with further data to specify JSTP extensions.

#### 3.1.2 Method

- Type: String
- _Required_

The method header represents the action to be performed on the identified resource.

> JSTP methods are much like HTTP methods, in fact JSTP supports almost all of them. If you are a REST developer, most of this will be familiar.

##### 3.1.2.1 GET

_todo_

##### 3.1.2.2 POST

_todo_

##### 3.1.2.3 PUT

_todo_

##### 3.1.2.4 PATCH

_todo_

##### 3.1.2.5 DELETE

_todo_

##### 3.1.2.6 BIND

_todo_

##### 3.1.2.7 RELEASE

_todo_

#### 3.1.3 Resource

- Type: Array of Strings
- Elements: An arbitrarily long array containing non-empty strings that represent the selected Resource.
- _Required_

The Resource is to be interpreted as a resource in the application. It can represent, for example:

- A file in a filesystem.
- A record in a database.
- A controller in a web application.

The resources can be accessed with several methods, so it may be possible to create, update, destroy or query resources via JSTP. Since JSTP is symmetrical and asynchronous, the possibilities are more diverse than CRUD (Crete, Read, Update, Delete), but still resources should represent as much as possible the range of actions in the application.

#### 3.1.4 Timestamp

- Type: Long Integer
- Element: The time when the Dispatch was issued in the UNIX time stamp format
- _Required_

The timestamp is a mandatory header. Its rationale is to simplify logging, synchronization and processing. 

#### 3.1.5 Token

- Type: Array of Scalars/Null Objects
- Elements: An arbitrarily long array containing strings, numbers (float, integers, etc), boolean values and even null values
- _Optional_

The token header is intended to enable the representation of several items, which include (but are not limited to):

- Session
- Transaction
- Client
- Credentials
- Flags

For example, an application may keep track of the session token to identify the user, or pass around her credentials (such as a public key for asymmetric encryption). An application may also keep track of the transaction ID to identify the Dispatches that got generated after another Dispatch was issues: this subsequent Dispatches will then share the transaction ID of the original one. 

This header is specially useful in the context of a distributed application where Dispatches that represent requests start computation in different applications that issue Dispatches that represent replies to that request.

The specifics of the order, format and usage of the tokens are not defined in this specification.

#### 3.1.6 Host

- Type: Array of Strings
- Elements: An arbitrarily long array of DNS domains or IP addresses
- _Optional_

The host header represents the destination host of the Dispatch. It may resolve to a _loopback_ (such as 127.0.0.1 in IPv4 or ::1 in IPv6). Depending on the values of this header, there are several possible scenarios for the outcome of the Dispatch in the Engine:

##### 3.1.6.1 Empty host

If the host header is null or an empty string, the Dispatch must be processed in the current Engine. This means that the subscribed resources (local or remote) in the matching Endpoints will be triggered and the Dispatch forwarded to them.

##### 3.1.6.2 The first host in the list resolves to loopback

If the host header has only one element and the address resolves to the host where the application is running, the engine should either remove the host header or at least empty it, and afterwars process the Dispatch as stated in the previous section [3.1.6.2].

If the host header has many several elements and the first address resolves to the host where the application is running, the engine should remove the first item from the list of hosts and proceed as described in the next section [3.1.6.3].

> Future versions of JSTP may support port selection. Some engines may implement a mechanism to parse a domain such as "localhost:77777" and use 77777 as the target JSTP engine port, but this is not normative.

##### 3.1.6.3 One or more hosts

If the host header has one or more hosts and the first element in the list does not resolve to loopback, the Engine must:

1. Remove the first element from the list of hosts
2. Attempt to connect to the destination host via the standard JSTP protocols (80, 33333) and send the Dispatch to the remote application

It comes naturally that if a series of hosts were specified in the header, each Engine will _todo_

#### 3.1.7 Body

_todo_

#### 3.1.8 Endpoint

_todo_

#### 3.1.9 Exception

_todo_

##### 3.1.9.1 400 Bad Request

_todo_

##### 3.1.9.2 404 Not Found

_todo_ 

##### 3.1.9.3 502 Not Gateway

_todo_

##### 3.1.9.4 505 JSTP Version Not Supported

_todo_

### 3.2 Extensions

_todo_

4 Forwarding
------------

_todo_

5 Subscription
--------------

_todo_

### 5.1 Endpoints

(pattern for "any amount of this"? such as ["foods", "..."])

### 5.2 Subscription pool

6 Engine
--------

_todo_

### 6.1 Networking

_todo_

#### 6.1.1 Transport protocols

_todo_

##### 6.1.1.1 TCP Sockets

_todo_

##### 6.1.1.2 Websockets

_todo_

#### 6.1.2 Environment

_todo_

### 6.2 Implementation guidelines

_todo_

#### 6.2.1 Version management

_todo_

#### 6.2.2 Tolerance and Quirks mode

(tolerate null on optional headers)
_todo_

7 Changes since previous versions
---------------------------------

(referer out)

(gateway out)

(host-as-first-item out)

(new verbs and syntax for the new verbs)

(endpoind header in)

8 Future
--------

8.1 Known issues

(may be the dispatches are too long: what abount BSON?)

8.1(other methods: options and head)

(subscribe to remote hosts: bind tunnel)

(jsstp: jstp secure)

9 Acknowledgements
------------------

### 5.1 Collaborators

- [Fernando Vía Canel](https://github.com/xaviervia)
- [Luciano Bertenasco](https://github.com/lbertenasco)
- [Matías Domingues](https://github.com/mannias)

10 License
---------

Copyright (C) 2013 Fetcher & Collaborators

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.