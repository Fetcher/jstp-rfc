JSTP/0.4 - JSON Transfer Protocol version 0.4
=============================================

> This document is work in progress

> Versions [0.2](version/pseudo0.2.md) and [0.3](version/pseudo0.3.md) were not described but represent modular updates prior to version 0.4.

1 Introduction
--------------

JSTP is a communication protocol designed to:

- Facilitate distributed computing with an abstract, high level API inspired in HTTP
- Standarize interactions among applications connecting with different roles either as clients or servers

JSTP is also designed to be up to the paradigm of modern applications:

- JSTP is JSON, which makes it trivial to parse the messages is modern programming languages.
- The API closely resembles REST, so is very natural to adopt for web developers.
- Responses are sent asynchronously, thus making it fit for parallel processing.
- Messages (_dispatches_) are symmetrical, so every node manages resources with the same API, whether is a server or a client node.
- Supports subscription (_binding_) to events in remote hosts.
- JSTP is extensible, since arbitrary headers can be added

### 1.1 Example

How does a regular JSTP Dispatch looks like?

```javascript
{
  "protocol":   ["JSTP", "0.4"],      // The protocol and version
  "method":     "GET",                // The method. Headers are case-insensitive but is customary to user uppercase
                                      // in this one after the HTTP convention
  "resource":   ["foods", "pizza"],   // The selected resource which is to be retrieved (since the method is GET)
  "timestamp":  1365647440759,        // The milliseconds since the 1970-01-01 00:00:00.000 (also known as the UNIX timestamp)
  "token":      ["3434h5098asr34h3"], // [optional] Just some id which the server will probably use to identify this request
  "host":       ["pizza.com.ar"],     // [optional] The destination host to which the Dispatch is to be sent
  "body":       {                     // [optional] A message body
    "message": "Let the cheese melt!"       
  }
}
```

#### 1.1.1 Subscription example

A subscription Dispatch looks slightly different:

```javascript
{
  "protocol":   ["JSTP", "0.4"],
  "method":     "BIND",               // I bind myself to this event
  "endpoint": {                       // The endpoint header carries a pattern which represents possible Dispatches
    "method":   "POST",               // The type of dispatches I'd like to subscribe to. It can be replaced with a wilcard (*)
    "resource": ["foods", "*"]        // The resource. The second element is a wildcard representing "anything"
  },
  "timestamp":  1365647440759,
  "token":      ["3434h5098asr34h3"],
  "host":       ["pizza.com.ar"]      // The host is still optional. I can perfectly subscribe for dispatches 
                                      // issued in this very engine  
}
```

### 1.2 Notation

JSTP Dispatches are designed from the bottom up to be as compatible with current industry standards as possible. That's why they can be represented as URLs or in a similar fashion to HTTP Requests. These notations are not normative however and is may not be supported in actual implementations.

#### 1.2.1 URL

The first example Dispatch may be represented as an URL like this:

    jstp://pizza.com.ar/foods/pizza

User Agents may convert this URL to the corresponding Dispatch

#### 1.2.2 HTTP⁻like syntax

The first example Dispatch may be represented in an HTTP-like notation like this:

```
GET /foods/pizza JSTP/0.4
host: pizza.com.ar
timestamp: 1365647440759
token: 3434h5098asr34h3

message: Let the cheese melt!
```

This notation should be used for clarity since raw JSON can be messy, for example it can be used in log files. 

The notation is documented here partially to showcase the similarities with HTTP, but may not be supported at all by the user agents.

2 Terminology
-------------

- Dispatch: A JSTP message. Dispatches are JSON serializations. Several dispatches may be separated


- Engine: An implementation of a JSTP client-server. Since JSTP is symmetric in design, implementations should be capables of both roles (thus _server_ being a misleading designation). Implementations may however be limited to one role due to the runtime enviroment (for example while in a web browser). Engine can also refer to an running instance of a client-server compliant with this specification.

- Dispatch processing: Whenever an Engine recognizes a Dispatch at aimed at it. The Dispatch doesn't get forwarded when is processed.

- Dispatch forwarding: Whenever an Engine finds that a Dispatch should be sent to another application, the Dispatch is forwarded to be processed in the remote application.

- Method: The action to be performed on the identified resource.

- Resource: The address of an actionable resource within the target application.

- Host: The computer in which the engine is running.

- Transport protocol: TCP sockets or Websockets. JSTP can be transported in various lower-level protocols.

- Client: An engine making a request to an application identified by its host (typically resolving its address through DNS or just using the IP).

- Inbound: A JSTP connection where the current engine has the server role.

- Outbound: A JSTP connnection where the current engine has the client role.

- Header: Any of the top level properties of the Dispatch object. For example: `protocol`, `method`, `body`...

- Endpoint: A description of a method/resource pair where both the method may be replaced by a wildcard and the resource may be replaced partially ot totally by a wilcard. The endpoint is a pattern representing the ocurrence or a series of Dispatches. It is normalized and it is applied in subscriptions.

- Subscription: The binding of an application resource which wants to receive the dispatches processed in this engine or a remote one. 

- Endpoint triggering: Whenever a Dispatch is processed the endpoints that match the Dispatch are triggered. If there are clients (internal or remote) subscribed to any of those endpoints, the Dispatch gets forwarded into them.

3 Dispatch
----------

The JSTP Dispatch is both the message object that gets sent over the network and the event that gets triggered in the destination application. When is sent over the network, the Dispatch is a JSON serialization: within the Engine, it may be represented as a Dispatch object according to the programming language conventions.

A Dispatch is conformed by a series of _Headers_. There are 8 supported Headers, but other, non-normalized Headers may be added. Engines should discard any headers that can't be understood.

All headers are case-insensitive.

### 3.1 Protocol

- Type: Array of Strings.
- Elements: 
  1. "JSTP" - A string stating that the Dispatch uses the JSTP protocol. This field is case insensitive.
  2. <version-number> - A string representing the JSTP version number.

The protocol header represents the JSTP protocol version that the emitting Engine is using, and subsequently the JSTP version that the Dispatch is written in. It consists of an array of strings, being the first "jstp" and the second the version number.

The version number must be used by the receiving Engine to process the Dispatch according to the

4 Forwarding
------------

5 Subscription
--------------

### 5.1 Endpoints

(pattern for "any amount of this"? such as ["foods", "..."])

### 5.2 Subscription pool

6 Engine
--------

### 6.1 Networking

#### 6.1.1 Transport protocols

#### 6.1.2 Environment

### 6.2 Implementation guidelines

#### 6.2.1 Version management

7 Changes since previous versions
---------------------------------

(referer out)

(gateway out)

(host-as-first-item out)

(new verbs and syntax for the new verbs)

(endpoind header in)

8 Future
--------

8.1 Known issues

(may be the dispatches are too long: what abount BSON?)

8.1(options method)

(subscribe to remote hosts: bind tunnel)

(jsstp: jstp secure)

9 Acknowledgements
------------------

### 5.1 Collaborators

- [Fernando Vía Canel](https://github.com/xaviervia)
- [Luciano Bertenasco](https://github.com/lbertenasco)
- [Matías Domingues](https://github.com/mannias)

10 License
---------

Copyright (C) 2013 Fetcher & Collaborators

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.